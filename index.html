<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Habit Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" id="themeColorMeta" content="#ffffff">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    /* ===== Base defaults (light-ish placeholders overridden by themes) ===== */
    :root{
      --switch-on-bg: var(--accent);
      --switch-on-border: var(--accent);
      --knob-on: #ffffff;
      --bg:#ffffff;
      --card:#ffffff;
      --ink:#0b0b0b;
      --muted:#334155;
      --accent:#2ad100;
      --accent-ink:#0b0b0b; /* NEW: readable text on accent bg */
      --border:#e5e7eb;
      --blur-bg:rgba(255,255,255,.78);
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --radius:18px;
      --control-bg:#ffffff;
      --control-fg:#0b0b0b;
      --switch-off:#eef2f6;
      --switch-off-border:#dde3ea;
      --knob:#ffffff;
      --hover:rgba(2,6,23,.06);
      --menu-hover:rgba(2,6,23,.06);
    }

    /* ===== Dark Neon / Cyberpunk presets ===== */
    :root[data-theme='neon-cyan']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#00e5ff; --accent-ink:#0b0b0b; --bg:#030712; --card:#0a0f1f; --ink:#f5f7ff; --muted:#eaeaff; --border:#101a2a; --blur-bg:rgba(10,15,31,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#0f172a; --control-fg:#ffffff; --switch-off:#0b1222; --switch-off-border:#08101c; --hover:#26293a; --menu-hover:#26293a; }
    :root[data-theme='magenta']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#ff2bd6; --accent-ink:#0b0b0b; --bg:#0e0014; --card:#180021; --ink:#fef2ff; --muted:#fde6ff; --border:#2a0037; --blur-bg:rgba(24,0,33,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#1a0223; --control-fg:#ffffff; --switch-off:#20002c; --switch-off-border:#15001f; --hover:#2a0a2f; --menu-hover:#2a0a2f; }
    :root[data-theme='ultraviolet']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#a46cff; --accent-ink:#0b0b0b; --bg:#070114; --card:#0f0920; --ink:#f7f2ff; --muted:#e8deff; --border:#1b0d38; --blur-bg:rgba(15,9,32,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#130e2a; --control-fg:#ffffff; --switch-off:#140f2e; --switch-off-border:#0e0a22; --hover:#251d3d; --menu-hover:#251d3d; }
    :root[data-theme='acid-lime']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#a7ff00; --accent-ink:#0b0b0b; --bg:#060a06; --card:#0e1310; --ink:#f5ffe8; --muted:#e6ffe1; --border:#101810; --blur-bg:rgba(14,19,16,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#121a14; --control-fg:#ffffff; --switch-off:#0f1512; --switch-off-border:#0a0f0c; --hover:#1f2a22; --menu-hover:#1f2a22; }
    :root[data-theme='laser-orange']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#ff8a00; --accent-ink:#0b0b0b; --bg:#120700; --card:#1b0b02; --ink:#fff7ef; --muted:#ffe9d6; --border:#261006; --blur-bg:rgba(27,11,2,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#1f1208; --control-fg:#ffffff; --switch-off:#21140b; --switch-off-border:#180f08; --hover:#2c1a10; --menu-hover:#2c1a10; }
    :root[data-theme='cyber-blue']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#00b7ff; --accent-ink:#0b0b0b; --bg:#02080f; --card:#071521; --ink:#e9f6ff; --muted:#d9efff; --border:#0a1c2c; --blur-bg:rgba(7,21,33,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#0b1d2e; --control-fg:#ffffff; --switch-off:#0b1723; --switch-off-border:#061117; --hover:#13283a; --menu-hover:#13283a; }
    :root[data-theme='noir']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#ffffff; --accent:#ffd60a; --accent-ink:#0b0b0b; --bg:#060607; --card:#0f0f12; --ink:#ffffff; --muted:#ffffff; --border:#17171c; --blur-bg:rgba(15,15,18,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#141418; --control-fg:#ffffff; --switch-off:#17171c; --switch-off-border:#101014; --hover:#242429; --menu-hover:#242429; }
    :root[data-theme='dark-mono']{ --switch-on-bg:#f5f5f5; --switch-on-border:#e5e5e5; --knob-on:#0b0b0b; --accent:#ffffff; --accent-ink:#0b0b0b; --bg:#0b0b0b; --card:#0b0b0b; --ink:#ffffff; --muted:#cccccc; --border:#333333; --blur-bg:rgba(11,11,11,.7); --shadow:0 12px 32px rgba(0,0,0,.6); --control-bg:#1a1a1a; --control-fg:#ffffff; --switch-off:#222222; --switch-off-border:#444444; --knob:#ffffff; --hover:#333333; --menu-hover:#333333; }

    /* ===== Light / White Neon presets (DEFAULT -> white-lime-ish) ===== */
    :root[data-theme='light-mono']{ --switch-on-bg:#121212; --switch-on-border:#0b0b0b; --knob-on:#ffffff; --accent:#0b0b0b; --accent-ink:#ffffff; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#333333; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#eef2f6; --switch-off-border:#dde3ea; --knob:#0b0b0b; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }
    :root[data-theme='white-green-yellow']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#0b0b0b; --accent:#D4FF00; --accent-ink:#0b0b0b; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#334155; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#ecf7ee; --switch-off-border:#ddeee1; --knob:#ffffff; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }
    :root[data-theme='white-cyan']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#0b0b0b; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#334155; --accent:#0bb7ff; --accent-ink:#0b0b0b; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#eef2f6; --switch-off-border:#dde3ea; --knob:#ffffff; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }
    :root[data-theme='white-magenta']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#0b0b0b; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#334155; --accent:#ff2bd6; --accent-ink:#0b0b0b; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#f1f1f6; --switch-off-border:#e5e6ef; --knob:#ffffff; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }
    :root[data-theme='white-violet']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#0b0b0b; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#334155; --accent:#7c5cff; --accent-ink:#0b0b0b; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#eef0ff; --switch-off-border:#e0e4ff; --knob:#ffffff; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }
    :root[data-theme='white-lime']{ --switch-on-bg:var(--accent); --switch-on-border:var(--accent); --knob-on:#0b0b0b; --bg:#ffffff; --card:#ffffff; --ink:#0b0b0b; --muted:#334155; --accent:#D4FF00; --accent-ink:#0b0b0b; --border:#e5e7eb; --blur-bg:rgba(255,255,255,.78); --shadow:0 10px 26px rgba(0,0,0,.08); --control-bg:#ffffff; --control-fg:#0b0b0b; --switch-off:#ecf7ee; --switch-off-border:#ddeee1; --knob:#ffffff; --hover:rgba(2,6,23,.06); --menu-hover:rgba(2,6,23,.06); }

    *{box-sizing:border-box}
    html,body{ -webkit-text-size-adjust: 100%; touch-action: manipulation;height:100%}
    body{ -webkit-text-size-adjust: 100%; touch-action: manipulation;
      margin:0;
      background: var(--bg);
      color:var(--ink);
      font-family: ui-rounded, -apple-system, BlinkMacSystemFont, 'SF Pro Rounded', 'SF Pro Text', Segoe UI, Roboto, Helvetica, Arial;
      padding: max(env(safe-area-inset-top), 10px) 14px 16px 14px;
      -webkit-font-smoothing: antialiased;
    }
    .app{ max-width: 430px; margin: 0 auto; }

    .nav{
      position: sticky; top: 0; z-index: 10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 8px 10px;
      border-radius: var(--radius);
      background: var(--blur-bg);
      backdrop-filter: saturate(180%) blur(14px);
      -webkit-backdrop-filter: saturate(180%) blur(14px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .brand img{ height:28px; width:auto; display:block; }
    .controls{ display:flex; gap:8px; align-items:center; position:relative; }

    .btn{ border:1px solid var(--border); background:var(--control-bg); color:var(--control-fg); border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; }
    .btn:focus-visible{ outline:3px solid color-mix(in srgb, var(--accent) 50%, transparent); outline-offset:2px; }

    .menu{ position:absolute; right:0; top:44px; background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow: var(--shadow); min-width: 240px; padding:6px; display:none; }
    .menu.open{ display:block; }
    .menu button{ width:100%; text-align:left; padding:10px 12px; background:transparent; border:none; color:var(--ink); border-radius:10px; cursor:pointer; font-weight:800; }
    .menu button:hover{ background: var(--menu-hover); }
    .menu .sw{ width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle; }
    .section{ padding:6px 10px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }

    .grid{ display:grid; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); }

    .panel{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip{ border:1px solid var(--border); background:var(--control-bg); padding:8px 10px; border-radius:999px; font-weight:800; cursor:pointer; color:var(--control-fg); }
    .chip.accent{ background:var(--accent); border-color:var(--accent); color:var(--accent-ink); box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 40%, transparent); }
    .chip[disabled]{ opacity:.45; cursor:not-allowed; }
    .chip.accent:focus-visible{ outline:3px solid color-mix(in srgb, var(--accent) 45%, transparent); outline-offset:2px; }

    .habit-header{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .habit-name{ font-weight:900; letter-spacing:.6px; font-size:18px; flex:1; }
    .habit-name[contenteditable="true"]{ outline:2px dashed color-mix(in srgb, var(--ink) 30%, transparent); border-radius:8px; padding:2px 6px; font-size:18px; }
    .icon{ background:transparent; border:none; color:var(--ink); cursor:pointer; padding:6px; border-radius:10px; }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 2px; }
    .day{ font-weight:900; letter-spacing:1.1px; min-width:60px; opacity:.98; }

    .switch{ position:relative; width:70px; height:34px; margin-left:auto; border-radius:17px; background:var(--switch-off); transition: background .2s ease; border:1px solid var(--switch-off-border); }
    .knob{ position:absolute; top:50%; left:3px; width:28px; height:28px; border-radius:14px; transform: translate(0,-50%); background:var(--knob); box-shadow:0 2px 10px rgba(0,0,0,.15); transition: transform .2s cubic-bezier(.22,.61,.36,1), box-shadow .2s; }
    .switch.on{ background: var(--switch-on-bg); border-color: var(--switch-on-border); box-shadow: 0 0 12px color-mix(in srgb, var(--accent) 35%, transparent); }
    .switch.on .knob{ transform: translate(36px,-50%); background: var(--knob-on); box-shadow:0 2px 10px rgba(0,0,0,.15); }

    .empty{ text-align:center; color:var(--muted); border:1px dashed var(--border); padding:22px; border-radius:14px; }
    .hint{ text-align:center; color:var(--muted); font-size:12px; margin-top:8px; }
  
    /* ===== Habit progress bar ===== */
    .progress{
      position: relative;
      width: 100%;
      height: 10px;
      background: var(--switch-off);
      border: 1px solid var(--switch-off-border);
      border-radius: 999px;
      overflow: hidden;
      margin: 8px 0 2px 0;
    }
    .progress__bar{
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width .25s ease;
    }
    .progress__label{
      position:absolute;
      top: -18px;
      right: 0;
      font-size: 11px;
      color: var(--muted);
      user-select:none;
    }

    /* ===== Finish row (right-aligned) ===== */
    .finish-row{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end; /* right align */
    }

    /* ===== Tiny toast for confirmations ===== */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(12px);
      padding: 10px 14px;
      background: var(--control-bg);
      color: var(--control-fg);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .02em;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
  <canvas id="confetti-canvas" style="position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; opacity:0; transition: opacity .25s ease;"></canvas>
  <div class="app">
    <div class="nav">
      <div class="brand"><img id="brandLogo" src="logo-light.png" alt="Habit Tracker logo"></div>
      <div class="controls">
        <button id="themeBtn" class="btn" aria-haspopup="true" aria-expanded="false" aria-controls="themeMenu">🎨</button>
        <div id="themeMenu" class="menu" role="menu" aria-label="Theme menu">
          <div class="section">Dark Neon</div>
          <button data-theme="neon-cyan" role="menuitem"><span class="sw" style="background:#00e5ff"></span>Neon Cyan</button>
          <button data-theme="magenta" role="menuitem"><span class="sw" style="background:#ff2bd6"></span>Magenta Pink</button>
          <button data-theme="ultraviolet" role="menuitem"><span class="sw" style="background:#a46cff"></span>Ultraviolet</button>
          <button data-theme="acid-lime" role="menuitem"><span class="sw" style="background:#a7ff00"></span>Acid Lime</button>
          <button data-theme="laser-orange" role="menuitem"><span class="sw" style="background:#ff8a00"></span>Laser Orange</button>
          <button data-theme="cyber-blue" role="menuitem"><span class="sw" style="background:#00b7ff"></span>Cyber Blue</button>
          <button data-theme="noir" role="menuitem"><span class="sw" style="background:#ffd60a"></span>Noir (Hi-Contrast)</button>
          <button data-theme="dark-mono" role="menuitem"><span class="sw" style="background:#0b0b0b"></span>Dark (Mono)</button>
          <div class="section">Light / White Neon</div>
          <button data-theme="light-mono" role="menuitem"><span class="sw" style="background:#ffffff; border:1px solid #eee;"></span>Light (Mono)</button>
          <button data-theme="white-green-yellow" role="menuitem"><span class="sw" style="background:#D4FF00"></span>White (Green/Yellow)</button>
          <button data-theme="white-cyan" role="menuitem"><span class="sw" style="background:#0bb7ff"></span>White Neon (Cyan)</button>
          <button data-theme="white-magenta" role="menuitem"><span class="sw" style="background:#ff2bd6"></span>White Neon (Magenta)</button>
          <button data-theme="white-violet" role="menuitem"><span class="sw" style="background:#7c5cff"></span>White Neon (Violet)</button>
          <button data-theme="white-lime" role="menuitem"><span class="sw" style="background:#D4FF00"></span>White Neon (Lime)</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:10px">
      <div class="panel">
        <button id="add" class="chip accent">+ New Habit</button>
        <button id="clear" class="chip accent">Clear Week</button>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No habits yet. Tap <b>New Habit</b> to start.</div>
    <div class="hint">Weekly view (Sun–Sat). Tap a switch to mark the day.</div>
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  </div>

  <script>
    const DAYS = ["SUN","MON","TUES","WED","THUR","FRI","SAT"];

    function showToast(msg){
      const el = document.getElementById('toast');
      if(!el) return;
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.classList.remove('show'), 1400);
    }

    // === Confetti Animation System ===
    function initializeConfetti(){
      const canvas = document.getElementById("confetti-canvas");
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      let particles = [];
      let rafId = null;

      function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      window.addEventListener("resize", resize, {passive:true}); resize();

      function particle(x,y){
        return { x, y, dx: Math.random()*6-3, dy: Math.random()*-5-2, size: Math.random()*6+4, color: `hsl(${Math.random()*360},80%,60%)`, life: 100 };
      }

      function stop(){
        if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
        ctx.clearRect(0,0,canvas.width,canvas.height);
        canvas.style.opacity = '0';
        particles = [];
      }

      function tick(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=particles.length-1;i>=0;i--){
          const p = particles[i];
          p.x += p.dx; p.y += p.dy; p.dy += 0.1; p.life--;
          ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
          if(p.life<=0) particles.splice(i,1);
        }
        if(particles.length>0){ rafId = requestAnimationFrame(tick); } else { stop(); }
      }

      window.fireConfetti = function(x = canvas.width/2, y = canvas.height/2){
        canvas.style.opacity = '1';
        for(let i=0;i<100;i++){ particles.push(particle(x,y)); }
        if(!rafId) tick();
      };
    }

    const store = {
      read(){ try{ return JSON.parse(localStorage.getItem("ios12-habits")||"[]"); }catch(e){ return []; } },
      write(d){ localStorage.setItem("ios12-habits", JSON.stringify(d)); }
    };
    const prefs = {
      read(){ try{ return JSON.parse(localStorage.getItem("ios12-prefs")||"{}"); }catch(e){ return {}; } },
      write(d){ localStorage.setItem("ios12-prefs", JSON.stringify(d)); }
    };

    const state = { habits: store.read() };

    function uid(){ return Math.random().toString(36).slice(2,9); }

    function render(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      document.getElementById('empty').style.display = state.habits.length ? 'none' : 'block';

      state.habits.forEach(habit=>{
        const card = document.createElement('div'); card.className='card';

        const header = document.createElement('div'); header.className='habit-header';
        const name = document.createElement('div'); name.className='habit-name'; name.textContent = habit.name || 'Habit';
        const edit = document.createElement('button'); edit.className='icon'; edit.textContent='✏️';
        const del = document.createElement('button'); del.className='icon'; del.textContent='🗑️';

        edit.addEventListener('click', ()=>{
          const editing = name.getAttribute('contenteditable')==='true';
          if(!editing){
            name.setAttribute('contenteditable','true'); name.focus(); document.execCommand?.('selectAll',false,null);
          }else{
            name.setAttribute('contenteditable','false'); habit.name = name.textContent.trim()||'Habit'; store.write(state.habits);
            updateProgress();
          }
        });
        name.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); name.blur(); } });
        name.addEventListener('blur', ()=>{
          if(name.getAttribute('contenteditable')==='true'){
            name.setAttribute('contenteditable','false'); habit.name = name.textContent.trim()||'Habit'; store.write(state.habits);
            updateProgress();
          }
        });
        del.addEventListener('click', ()=>{
          showToast('Habit deleted');
          state.habits = state.habits.filter(h=>h.id!==habit.id); store.write(state.habits);
          render();
        });

        header.append(name, edit, del);
        card.appendChild(header);

        // Progress bar
        const progress = document.createElement('div'); progress.className = 'progress';
        const bar = document.createElement('div'); bar.className = 'progress__bar';
        const label = document.createElement('div'); label.className = 'progress__label';
        progress.append(bar, label);
        card.appendChild(progress);

        function updateProgress(){
          const done = habit.week.filter(Boolean).length;
          const pct = Math.round((done/7)*100);
          bar.style.width = pct + '%';
          progress.setAttribute('role','progressbar');
          progress.setAttribute('aria-valuemin','0');
          progress.setAttribute('aria-valuemax','7');
          progress.setAttribute('aria-valuenow', String(done));
          progress.title = done + '/7 days completed';
          label.textContent = pct + '%';
          // NOTE: Removed auto-confetti on 7/7 to comply with "only on Finish Week"
        }
        updateProgress();

        // Days toggles
        DAYS.forEach((d,i)=>{
          const row = document.createElement('div'); row.className='row';
          const labelDay = document.createElement('div'); labelDay.className='day'; labelDay.textContent = d;
          const sw = document.createElement('div'); sw.className = 'switch'+(habit.week[i]?' on':'');
          const knob = document.createElement('div'); knob.className='knob';
          sw.appendChild(knob);

          const toggle = ()=>{
            habit.week[i] = !habit.week[i];
            sw.classList.toggle('on', habit.week[i]);
            store.write(state.habits);
            updateProgress();
            updateFinishWeekButtonState();
          };
          sw.addEventListener("click", toggle, {passive:true});
          knob.addEventListener("click", (e)=>{ e.stopPropagation(); toggle(); }, {passive:true});

          row.append(labelDay, sw);
          card.appendChild(row);
        });

        // Finish Week button (right-aligned row)
        const finishRow = document.createElement('div'); finishRow.className = 'finish-row';
        const finishHabitBtn = document.createElement("button");
        finishHabitBtn.id = `finishWeekBtn-${habit.id}`;
        finishHabitBtn.className = "chip accent";
        finishHabitBtn.textContent = "Finish Week";
        finishHabitBtn.disabled = true;

        finishHabitBtn.addEventListener('click', ()=>{
          if (finishHabitBtn.disabled) return;
          window.fireConfetti && window.fireConfetti();
          showToast('Great job finishing the week!');
          // Remove/close this card
          state.habits = state.habits.filter(h=>h.id!==habit.id);
          store.write(state.habits);
          render();
        });

        finishRow.appendChild(finishHabitBtn);
        card.appendChild(finishRow);

        grid.appendChild(card);
      });
      updateFinishWeekButtonState(); // Update button state after rendering habits
    }

    function updateFinishWeekButtonState() {
      state.habits.forEach(habit => {
        const finishHabitBtn = document.getElementById(`finishWeekBtn-${habit.id}`);
        if (finishHabitBtn) {
          const anyDayToggled = habit.week.some(day => day);
          finishHabitBtn.disabled = !anyDayToggled;
          finishHabitBtn.setAttribute('aria-disabled', String(!anyDayToggled));
          if (anyDayToggled) {
            finishHabitBtn.classList.add("accent");
          } else {
            finishHabitBtn.classList.remove("accent");
          }
        }
      });
    }

    // Theme dropdown with default 'white-green-yellow' + logo/meta switching
    (function initTheme(){
      const meta = document.getElementById("themeColorMeta");
      const logo = document.getElementById("brandLogo");
      const btn = document.getElementById("themeBtn");
      const menu = document.getElementById("themeMenu");
      let { theme } = prefs.read();
      if(!theme){ theme = 'white-green-yellow'; }  // DEFAULT

      const lightThemes = new Set(['light-mono', 'white-green-yellow', 'white-cyan','white-magenta','white-violet','white-lime']);

      function setTheme(t){
        document.documentElement.setAttribute('data-theme', t);
        if(lightThemes.has(t)){
          logo.src = 'logo-light.png';
          meta.setAttribute('content', '#ffffff');
        }else{
          logo.src = 'logo-dark.png';
          meta.setAttribute('content', '#0b0b0f');
        }
        prefs.write({ theme: t });
      }

      btn.addEventListener('click', ()=>{
        const open = menu.classList.toggle('open');
        btn.setAttribute('aria-expanded', String(open));
      });
      document.addEventListener('click', (e)=>{
        if(!menu.contains(e.target) && e.target!==btn){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      });
      menu.querySelectorAll('button[data-theme]').forEach(b=> b.addEventListener('click', ()=>{
        setTheme(b.dataset.theme); menu.classList.remove('open'); btn.setAttribute('aria-expanded','false');
      }));
      setTheme(theme);
    })();

    document.getElementById('add').addEventListener('click', ()=>{
      state.habits.push({ id: uid(), name:'Habit', week:[false,false,false,false,false,false,false] });
      store.write(state.habits);
      render();
      showToast("Habit added");
      updateFinishWeekButtonState();
    });
    document.getElementById('clear').addEventListener('click', ()=>{
      state.habits = state.habits.map(h=>({ ...h, week:[false,false,false,false,false,false,false] }));
      store.write(state.habits);
      render();
      showToast("Week cleared");
    });

    // Removed global #finishWeekBtn listener (not present in DOM)

    if(state.habits.length===0){
      state.habits=[{id:uid(), name:'Workout', week:[false,false,false,false,false,false,false]}];
      store.write(state.habits);
      render();
    } else {
      render();
    }

    initializeConfetti(); // Initialize confetti once after initial render

    if("serviceWorker" in navigator){ window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw.js")); }
  </script>
</body>
</html>
